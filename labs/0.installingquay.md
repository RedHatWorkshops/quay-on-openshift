# Installing Quay

In this lab we will be going through installing Quay and it's prereqs. 


## Prerequisites


In the current release of Quay, you'll only be able to install on a project called `quay-enterprise`. This project needs to have `anyuid` capabilites.

Create the project as `system:admin` and give it access to run `anyuid` containers.

```
oc login -u system:admin
oc new-project quay-enterprise
oc adm policy add-scc-to-user anyuid -z default -n quay-enterprise
```

The rest of the installation can be done with a "standard" user. So give this user admin access to `quay-enterprise`. For this example, I am using the `devloper` user (your user may vary)

```
oc adm policy add-role-to-user admin developer -n quay-enterprise
```

Download the installation/setup YAMLs. We will be using these for the installation.

```
mkdir ./quaydeploy
cd ./quaydeploy
wget https://coreos.com/quay-enterprise/docs/latest/tectonic/files/quay-enterprise-namespace.yml
wget https://coreos.com/quay-enterprise/docs/latest/tectonic/files/quay-enterprise-config-secret.yml
wget https://coreos.com/quay-enterprise/docs/latest/tectonic/files/quay-enterprise-redis.yml
wget https://coreos.com/quay-enterprise/docs/latest/tectonic/files/quay-enterprise-app-rc.yml
wget https://coreos.com/quay-enterprise/docs/latest/tectonic/files/quay-enterprise-service-nodeport.yml
wget https://coreos.com/quay-enterprise/docs/latest/tectonic/files/quay-enterprise-service-loadbalancer.yml
wget https://coreos.com/quay-enterprise/docs/latest/tectonic/files/quay-servicetoken-role-k8s1-6.yaml
wget https://coreos.com/quay-enterprise/docs/latest/tectonic/files/quay-servicetoken-role-binding-k8s1-6.yaml
```

For ease of use, export your OpenShift's default route.

```
export ocproute=$(oc get routes -n default docker-registry -o jsonpath='{.spec.host}'  | cut -d'.' -f2-)
```

Make sure you have either `podman` or `docker` installed. If not, install it and verify it with the following command

```
docker version
```

Finally switch to your regular user (in my case it was `developer`).

```
oc login -u developer
```

You should see `quay-enterprise` as one of your listed projects

```
$ oc whoami
developer

$ oc get projects
NAME              DISPLAY NAME   STATUS
quay-enterprise                  Active
```
## Deploying Quay

In order to deploy Quay, you'll need access to the container images via a docker config file. You can get one by simply running `docker login` against the quay.io registry. You can get the login command from [this kbase article](https://access.redhat.com/solutions/3533201)

Run that command in the terminal

```
docker login -u="coreos+rhcp" ...... quay.io
```

This should create/update the `` file

```
$ ll -d ~/.docker/config.json
-rw-------. 1 ec2-user ec2-user 400 Jan 15 00:19 /home/ec2-user/.docker/config.json
```

Once you have this file, upload it to OpenShift and create the config secret

```
oc create -f quay-enterprise-config-secret.yml
oc create secret generic coreos-pull-secret \
--from-file=".dockerconfigjson=$HOME/.docker/config.json" --type='kubernetes.io/dockerconfigjson' -n quay-enterprise
```

Now you have to create the role and it's corresponding bindings (you must run this as `system:admin`). You have to add `anyuid` to this new role.

```
oc login -u system:admin
oc project quay-enterprise
oc create -f quay-servicetoken-role-k8s1-6.yaml -n quay-enterprise
oc create -f quay-servicetoken-role-binding-k8s1-6.yaml -n quay-enterprise
oc adm policy add-scc-to-user anyuid system:serviceaccount:quay-enterpriseefault
oc login -u developer
oc project quay-enterprise
```

You are now ready to deploy Redis and Quay.

```
oc create -f quay-enterprise-app-rc.yml -f quay-enterprise-service-loadbalancer.yml
```

Expose the route.

```
oc expose svc quay-enterprise --name=quay --hostname=quay.${ocproute}
```

If you visit this URL, you'll see something like this...

![quay-splash](images/quay-setup-db-initialscreen.png)

That means it's up and running! Before we set this up; we'll have to deploy a database first.

## Deploying A Database
