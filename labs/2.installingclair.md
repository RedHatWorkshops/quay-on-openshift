# Installing Clair

Clair is an open source project for the static analysis of vulnerabilities in `appc` and `docker` containers. It's the default scanner for `quay`. 

Vulnerability data is continuously imported from a known set of sources and correlated with the indexed contents of container images in order to produce lists of vulnerabilities that threaten a container.

The following sections explain how to set up clair and connect it to quay.

## Set Up Quay

Under the admin panel, click on the gear icon to the left to reach the "Registry Settngs"


![clar-quay-reg-settings](images/quay-reg-settings.png)

Once here scroll down until you see `Security Scanner` and tick off `Enable Security Scanning`. In the `Security Scanner Endpoint` enter `http://clair:6060`. It should look like this.

![clair-sec-scan-sec](images/clair-settings.png)

To connect Quay Enterprise securely to the scanner, click `Create Key >` to create an authentication key between Quay and the Security Scanner. This will bring up a window, select `Generate shared key`


![clair-quay-key](https://coreos.com/quay-enterprise/docs/latest/img/security-scanner-generate-shared.png)

Enter an optional expiration date, and click `Generate Key`

![clair-quay-gnekey](https://coreos.com/quay-enterprise/docs/latest/img/security-scanner-generate-shared-dialog.png)

**Save the key ID** and download the preshared private key into your `$HOME` directory.

![clair-keyid-preshared](https://coreos.com/quay-enterprise/docs/latest/img/security-scanner-shared-key.png)

Now move on to installing `clair`

## Setup Clair

Now, export some environment vars

```
export POSTGRES_CONNECTION_STRING="postgresql://quay:quay@postgresql:5432/clair?sslmode=disable"
export QUAY_ENDPOINT=$(oc get svc quay-enterprise -o jsonpath='{.metadata.name'})
export CLAIR_ENDPOINT=clair:6060
export CLAIR_SERVICE_KEY_ID=<your key id>
```

**NOTE** replace `<your key id>` with the key id you got from the quay config screen.


Download the clair config yaml template

```
wget https://raw.githubusercontent.com/RedHatWorkshops/quay-on-openshift/master/labs/resources/clair-config-TEMPLATE.yaml
```

Create a new config based on your env vars and this template

```
envsubst < clair-config-TEMPLATE.yaml > clair-config.yaml
```

Verify your changes with...

```
diff clair-config-TEMPLATE.yaml clair-config.yaml
```

Next, create the configmaps from the `clair-config.yaml` file you've just created and from the `security_scanner.pem` file you've downloaded into your `$HOME` dir.

```
mv $HOME/security_scanner.pem .
oc create configmap clair-config --from-file="config.yaml=clair-config.yaml"
oc create configmap security-scanner --from-file="$HOME/security_scanner.pem=security_scanner.pem"
```

## Deploy Clair

First, you need to download the clair image. Verify you still have connection to the quay.io repository. (If you don't, you need to login again as outlined in the [installing quay lab](0.installingquay.md#deploying-quay))

```
$ grep -c quay ~/.docker/config.json
1
```
